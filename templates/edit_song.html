{% extends "base.html" %}

{% block title %}Edit Song - HastingTX Music{% endblock %}

{% block content %}
<div class="upload-page">
    <h1>Edit Song: {{ song.title }}</h1>

    <div id="edit-form-container">
        <form id="edit-form">
            <div class="form-section">
                <h3>Song Information</h3>

                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" value="{{ song.title }}" required>
                </div>

                <div class="form-group">
                    <label for="artist">Artist</label>
                    <input type="text" id="artist" name="artist" value="{{ song.artist or '' }}">
                </div>

                <div class="form-group">
                    <label for="album">Album</label>
                    <input type="text" id="album" name="album" value="{{ song.album or '' }}">
                </div>

                <div class="form-group">
                    <label for="genre-select">Genre</label>
                    <select id="genre-select" onchange="handleGenreSelect()">
                        <option value="">-- Select Genre --</option>
                        {% for genre in genres %}
                        {% if not genre.parent_genre_id %}
                        <option value="{{ genre.name }}" {% if song.genre == genre.name %}selected{% endif %}>{{ genre.name }}</option>
                        {% endif %}
                        {% endfor %}
                        <option value="__new__">+ Create New Genre</option>
                    </select>
                    <input type="hidden" id="genre-hidden" name="genre" value="{{ song.genre or '' }}">

                    <!-- Sub-genre selector (shown when parent genre selected) -->
                    <div id="subgenre-container" style="display: none; margin-top: 0.5rem;">
                        <label for="subgenre-select">Sub-genre (optional)</label>
                        <select id="subgenre-select" onchange="handleSubgenreSelect()">
                            <option value="">-- No sub-genre --</option>
                        </select>
                    </div>

                    <!-- New genre form -->
                    <div id="new-genre-form" style="display: none; margin-top: 0.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                        <div class="form-group">
                            <label for="new-genre-name">New Genre Name *</label>
                            <input type="text" id="new-genre-name" placeholder="Enter genre name">
                        </div>
                        <div class="form-group">
                            <label for="new-genre-parent">Parent Genre (for sub-genre)</label>
                            <select id="new-genre-parent">
                                <option value="">-- None (top-level genre) --</option>
                                {% for genre in genres %}
                                {% if not genre.parent_genre_id %}
                                <option value="{{ genre.id }}">{{ genre.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new-genre-desc">Description (optional)</label>
                            <input type="text" id="new-genre-desc" placeholder="Brief description">
                        </div>
                        <button type="button" class="btn btn-small" onclick="createNewGenre()">Create Genre</button>
                        <button type="button" class="btn btn-small btn-secondary" onclick="cancelNewGenre()">Cancel</button>
                        <div id="genre-create-status" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3">{{ song.description or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="lyrics">Lyrics</label>
                    <textarea id="lyrics" name="lyrics" rows="10">{{ song.lyrics or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="composer">Composer</label>
                    <input type="text" id="composer" name="composer" value="{{ song.composer or '' }}">
                </div>

                <div class="form-group">
                    <label for="lyricist">Lyricist</label>
                    <input type="text" id="lyricist" name="lyricist" value="{{ song.lyricist or '' }}">
                </div>

                <div class="form-group">
                    <label for="recording_date">Recording Date</label>
                    <input type="date" id="recording_date" name="recording_date" value="{{ song.recording_date.strftime('%Y-%m-%d') if song.recording_date else '' }}">
                </div>

                <div class="form-group">
                    <label for="cover_art">Cover Art (optional)</label>
                    {% if song.cover_art %}
                    <div class="current-cover">
                        <p><strong>Current:</strong> {{ song.cover_art }}</p>
                        <img src="{{ url_for('static', filename='uploads/covers/' + song.cover_art) }}" alt="Current cover" style="max-width: 200px; max-height: 200px;">
                    </div>
                    {% endif %}
                    <input type="file" id="cover_art" name="cover_art" accept="image/*">
                    <small>Upload new cover art to replace existing. Will be resized to 500x500 if larger.</small>
                </div>

                <div class="form-group">
                    <label for="identifier">URL Identifier</label>
                    <input type="text" id="identifier" name="identifier" value="{{ song.identifier }}" placeholder="my-song-title">
                    <small>Current URL: /music/<strong>{{ song.identifier }}</strong></small>
                </div>
            </div>

            <div class="form-section">
                <h3>Tags</h3>
                <div class="tag-checkboxes checkbox-grid">
                    {% for tag in tags %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="tags[]" value="{{ tag.id }}"
                            {% if tag.id in song_tag_ids %}checked{% endif %}>
                        #{{ tag.name }}
                    </label>
                    {% endfor %}
                </div>
                <div class="new-tag-inline" style="margin-top: 0.5rem;">
                    <input type="text" id="new-tag-name" placeholder="Add new tag" style="width: 150px; display: inline-block;">
                    <button type="button" class="btn btn-small" onclick="createNewTag()">Add</button>
                    <span id="tag-create-status" style="margin-left: 0.5rem;"></span>
                </div>
            </div>

            <div class="form-section">
                <h3>Playlists</h3>
                <p>Select which playlists this song belongs to:</p>
                <div class="playlist-checkboxes">
                    {% for playlist in playlists %}
                    {% if playlist.identifier != 'all' %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="playlists[]" value="{{ playlist.id }}"
                            {% if playlist.id in song_playlist_ids %}checked{% endif %}>
                        {{ playlist.name }}
                    </label>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="form-section">
                <h3>File Information (Read-Only)</h3>
                <p><strong>Filename:</strong> {{ song.filename }}</p>
                <p><strong>Duration:</strong> {{ song.duration|duration }}</p>
                <p><strong>File Size:</strong> {{ song.file_size|filesize }}</p>
                <p><strong>Uploaded:</strong> {{ song.upload_date.strftime('%Y-%m-%d %H:%M') if song.upload_date else 'Unknown' }}</p>
                <p><strong>Listens:</strong> {{ song.listen_count or 0 }}</p>
                <p><strong>Downloads:</strong> {{ song.download_count or 0 }}</p>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn">Save Changes</button>
                <a href="{{ url_for('song', identifier=song.identifier) }}" class="btn btn-secondary">Cancel</a>
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">Back to Admin</a>
            </div>
        </form>

        <div id="update-success" class="success-message" style="display: none;">
            <h2>Update Successful!</h2>
            <p id="success-message"></p>
            <div class="success-actions">
                <a id="view-song-link" href="#" class="btn btn-primary">View Song</a>
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">Back to Admin</a>
            </div>
        </div>

        <div id="update-error" class="error-message" style="display: none;">
            <h2>Update Failed</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="btn btn-secondary">Try Again</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const editForm = document.getElementById('edit-form');
const submitBtn = document.getElementById('submit-btn');

// Genre data from server
let allGenres = [
    {% for genre in genres %}
    {id: {{ genre.id }}, name: "{{ genre.name }}", parent_genre_id: {{ genre.parent_genre_id or 'null' }}},
    {% endfor %}
];

// Find the current genre in our list to determine if it's a subgenre
const currentGenre = "{{ song.genre or '' }}";
const currentGenreObj = allGenres.find(g => g.name === currentGenre);

// Initialize genre selector on page load
document.addEventListener('DOMContentLoaded', function() {
    if (currentGenreObj && currentGenreObj.parent_genre_id) {
        // Current genre is a subgenre - select the parent and show subgenres
        const parentGenre = allGenres.find(g => g.id === currentGenreObj.parent_genre_id);
        if (parentGenre) {
            document.getElementById('genre-select').value = parentGenre.name;
            // Trigger the parent selection to populate subgenres
            handleGenreSelect();
            // Then select the current subgenre
            document.getElementById('subgenre-select').value = currentGenre;
        }
    }
});

// Genre selection handling
function handleGenreSelect() {
    const select = document.getElementById('genre-select');
    const hiddenInput = document.getElementById('genre-hidden');
    const newGenreForm = document.getElementById('new-genre-form');
    const subgenreContainer = document.getElementById('subgenre-container');

    if (select.value === '__new__') {
        newGenreForm.style.display = 'block';
        subgenreContainer.style.display = 'none';
        hiddenInput.value = '';
    } else if (select.value) {
        newGenreForm.style.display = 'none';
        hiddenInput.value = select.value;

        // Check if this genre has sub-genres
        const subgenres = allGenres.filter(g => {
            const parent = allGenres.find(p => p.name === select.value);
            return parent && g.parent_genre_id === parent.id;
        });

        if (subgenres.length > 0) {
            populateSubgenres(subgenres);
            subgenreContainer.style.display = 'block';
        } else {
            subgenreContainer.style.display = 'none';
        }
    } else {
        newGenreForm.style.display = 'none';
        subgenreContainer.style.display = 'none';
        hiddenInput.value = '';
    }
}

function populateSubgenres(subgenres) {
    const select = document.getElementById('subgenre-select');
    select.innerHTML = '<option value="">-- No sub-genre --</option>';
    for (const sg of subgenres) {
        const option = document.createElement('option');
        option.value = sg.name;
        option.textContent = sg.name;
        select.appendChild(option);
    }
}

function handleSubgenreSelect() {
    const genreSelect = document.getElementById('genre-select');
    const subgenreSelect = document.getElementById('subgenre-select');
    const hiddenInput = document.getElementById('genre-hidden');

    if (subgenreSelect.value) {
        // Use subgenre as the genre value
        hiddenInput.value = subgenreSelect.value;
    } else {
        // Use parent genre
        hiddenInput.value = genreSelect.value;
    }
}

async function createNewGenre() {
    const name = document.getElementById('new-genre-name').value.trim();
    const parentId = document.getElementById('new-genre-parent').value || null;
    const description = document.getElementById('new-genre-desc').value.trim();
    const status = document.getElementById('genre-create-status');

    if (!name) {
        status.innerHTML = '<span class="warning-alert">Genre name is required</span>';
        return;
    }

    status.innerHTML = 'Creating...';

    try {
        const response = await fetch('/api/genres', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: description || null,
                parent_genre_id: parentId ? parseInt(parentId) : null
            })
        });

        const data = await response.json();

        if (data.success) {
            // Add to local genres array
            allGenres.push(data.genre);

            // Add to appropriate select
            const genreSelect = document.getElementById('genre-select');
            const parentSelect = document.getElementById('new-genre-parent');

            if (parentId) {
                // It's a sub-genre - update the parent's subgenre list if visible
                status.innerHTML = `<span class="warning-info">Sub-genre "${name}" created!</span>`;
            } else {
                // Top-level genre - add to main select before the "Create New" option
                const newOption = document.createElement('option');
                newOption.value = name;
                newOption.textContent = name;
                const createOption = genreSelect.querySelector('option[value="__new__"]');
                genreSelect.insertBefore(newOption, createOption);

                // Also add to parent genre select
                const parentOption = document.createElement('option');
                parentOption.value = data.genre.id;
                parentOption.textContent = name;
                parentSelect.appendChild(parentOption);

                status.innerHTML = `<span class="warning-info">Genre "${name}" created!</span>`;
            }

            // Select the new genre
            document.getElementById('genre-hidden').value = name;

            // Clear form after short delay
            setTimeout(() => {
                document.getElementById('new-genre-name').value = '';
                document.getElementById('new-genre-desc').value = '';
                document.getElementById('new-genre-parent').value = '';
                document.getElementById('new-genre-form').style.display = 'none';
                genreSelect.value = name;
            }, 1500);
        } else {
            status.innerHTML = `<span class="warning-alert">${data.error}</span>`;
        }
    } catch (error) {
        status.innerHTML = `<span class="warning-alert">Error: ${error.message}</span>`;
    }
}

function cancelNewGenre() {
    document.getElementById('new-genre-form').style.display = 'none';
    document.getElementById('genre-select').value = '';
    document.getElementById('genre-hidden').value = '';
    document.getElementById('new-genre-name').value = '';
    document.getElementById('new-genre-desc').value = '';
    document.getElementById('new-genre-parent').value = '';
    document.getElementById('genre-create-status').innerHTML = '';
}

editForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(editForm);

    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    try {
        const response = await fetch('/admin/songs/{{ song.id }}/edit', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Show success message
            document.getElementById('edit-form-container').querySelector('form').style.display = 'none';
            document.getElementById('success-message').textContent = `"${data.song.title}" has been updated successfully!`;
            document.getElementById('view-song-link').href = data.url;
            document.getElementById('update-success').style.display = 'block';
        } else {
            throw new Error(data.error || 'Update failed');
        }
    } catch (error) {
        console.error('Update error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('update-error').style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
    }
});

// Create new tag
async function createNewTag() {
    const nameInput = document.getElementById('new-tag-name');
    const status = document.getElementById('tag-create-status');
    const name = nameInput.value.trim().toLowerCase();

    if (!name) {
        status.innerHTML = '<span class="warning-alert">Tag name required</span>';
        return;
    }

    status.innerHTML = 'Creating...';

    try {
        const response = await fetch('/api/tags', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        });

        const data = await response.json();

        if (data.success) {
            // Add checkbox for new tag
            const container = document.querySelector('.tag-checkboxes');
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.innerHTML = `<input type="checkbox" name="tags[]" value="${data.tag.id}" checked> #${data.tag.name}`;
            container.appendChild(label);

            nameInput.value = '';
            status.innerHTML = `<span class="warning-info">Tag "#${data.tag.name}" created!</span>`;
            setTimeout(() => { status.innerHTML = ''; }, 2000);
        } else {
            status.innerHTML = `<span class="warning-alert">${data.error}</span>`;
        }
    } catch (error) {
        status.innerHTML = `<span class="warning-alert">Error: ${error.message}</span>`;
    }
}
</script>
{% endblock %}
