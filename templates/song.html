{% extends "base.html" %}

{% block title %}{{ song.title }} - HastingTX Music{% endblock %}

{% block content %}
<div class="song-player">
    <div class="song-header">
        {% if song.cover_art %}
        <div class="cover-art">
            <img src="{{ url_for('static', filename='uploads/covers/' + song.cover_art) }}" alt="{{ song.title }} cover art">
        </div>
        {% endif %}
        <div class="header-text">
            <h1>{{ song.title }}</h1>
            {% if song.artist %}
            <p class="artist">by {{ song.artist }}</p>
            {% endif %}
            {% if song.album %}
            <p class="album">from {{ song.album }}</p>
            {% endif %}
            {% if song.composer or song.lyricist %}
            <div class="credits">
                {% if song.composer %}
                <p class="composer"><strong>Composer:</strong> {{ song.composer }}</p>
                {% endif %}
                {% if song.lyricist %}
                <p class="lyricist"><strong>Lyricist:</strong> {{ song.lyricist }}</p>
                {% endif %}
            </div>
            {% endif %}
            {% if song.recording_date %}
            <p class="recording-date"><strong>Recorded:</strong> {{ song.recording_date.strftime('%B %d, %Y') if song.recording_date else '' }}</p>
            {% endif %}
        </div>
    </div>

    <div class="player-section">
        <audio id="audio-player" controls preload="auto">
            <source src="{{ url_for('static', filename='uploads/' + song.filename) }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>

    <div class="song-actions">
        <a href="{{ url_for('download_song', identifier=song.identifier) }}" class="btn btn-primary">
            Download MP3
        </a>
        {% if is_admin_ip %}
        <a href="{{ url_for('edit_song', song_id=song.id) }}" class="btn btn-secondary">
            Edit Song
        </a>
        <a href="{{ url_for('upload') }}" class="btn btn-secondary">
            Upload New Song
        </a>
        {% endif %}
    </div>

    <div class="song-stats">
        <span class="stat">
            <strong>Listens:</strong> {{ song.listen_count or 0 }}
        </span>
        <span class="stat">
            <strong>Downloads:</strong> {{ song.download_count or 0 }}
        </span>
        {% if song.duration %}
        <span class="stat">
            <strong>Duration:</strong> {{ song.duration|duration }}
        </span>
        {% endif %}
        {% if song.file_size %}
        <span class="stat">
            <strong>Size:</strong> {{ song.file_size|filesize }}
        </span>
        {% endif %}
    </div>

    <!-- Rating Section -->
    <div class="rating-section">
        <h3>Rate this song</h3>

        {% if rating_count >= 4 and avg_rating %}
        <div class="average-rating">
            <div class="rating-display">
                <span class="rating-value">{{ avg_rating }}</span> / 10
            </div>
            <div class="rating-count">Based on {{ rating_count }} rating{% if rating_count != 1 %}s{% endif %}</div>
        </div>
        {% elif rating_count > 0 %}
        <div class="rating-count">{{ rating_count }} rating{% if rating_count != 1 %}s{% endif %} so far (need 4 to display average)</div>
        {% endif %}

        <div class="rating-input">
            <div class="rating-stars" data-song-id="{{ song.id }}" data-current-rating="{{ user_rating or 0 }}">
                {% for i in range(1, 11) %}
                <button class="star-btn {% if user_rating and i <= user_rating %}active{% endif %}" data-rating="{{ i }}">
                    {{ i }}
                </button>
                {% endfor %}
            </div>
            {% if user_rating %}
            <p class="user-rating-text">Your rating: {{ user_rating }}/10</p>
            {% else %}
            <p class="user-rating-text">Click a number to rate</p>
            {% endif %}
        </div>
    </div>

    {% if song.description %}
    <div class="song-description">
        <h3>About this song</h3>
        <p>{{ song.description }}</p>
    </div>
    {% endif %}

    {% if song.lyrics %}
    <div class="song-lyrics">
        <h3>Lyrics</h3>
        <pre>{{ song.lyrics }}</pre>
    </div>
    {% endif %}

    {% if song.genre or song_tags %}
    <div class="song-metadata">
        {% if song.genre %}
        <p><strong>Genre:</strong> {{ song.genre }}</p>
        {% endif %}
        {% if song_tags %}
        <p><strong>Tags:</strong>
            {% for tag in song_tags %}
            <a href="{{ url_for('tag', tag_name=tag.name) }}" class="tag-link">#{{ tag.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
        </p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Comments Section -->
    <div class="comments-section">
        <h3>Comments ({{ comment_count }})</h3>

        <!-- Comment Form -->
        <div class="comment-form-container">
            <form id="comment-form">
                <div class="form-group">
                    <label for="commenter_name">Your Name (optional)</label>
                    <input type="text" id="commenter_name" name="commenter_name" maxlength="100" placeholder="Anonymous">
                </div>
                <div class="form-group">
                    <label for="comment_text">Comment *</label>
                    <textarea id="comment_text" name="comment_text" rows="3" maxlength="2000" required placeholder="Share your thoughts about this song..."></textarea>
                    <small class="char-count"><span id="char-count">0</span>/2000 characters</small>
                </div>
                <button type="submit" class="btn btn-primary" id="submit-comment-btn">Post Comment</button>
            </form>
            <div id="comment-success" class="success-message" style="display: none;">
                <p>Comment posted successfully!</p>
            </div>
            <div id="comment-error" class="error-message" style="display: none;">
                <p id="comment-error-text"></p>
            </div>
        </div>

        <!-- Comments List -->
        <div class="comments-list" id="comments-list">
            {% if comments %}
                {% for comment in comments %}
                <div class="comment" data-comment-id="{{ comment.id }}">
                    <div class="comment-header">
                        <span class="commenter-name">{{ comment.commenter_name or 'Anonymous' }}</span>
                        <span class="comment-date">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                        {% if is_admin_ip %}
                        <button class="btn-delete-comment" data-comment-id="{{ comment.id }}" title="Delete comment">Ã—</button>
                        {% endif %}
                    </div>
                    <div class="comment-text">{{ comment.comment_text }}</div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-comments">No comments yet. Be the first to comment!</p>
            {% endif %}
        </div>
    </div>

    <div class="back-link">
        <a href="{{ url_for('playlist', identifier='all') }}">&larr; Back to all songs</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Rating submission
document.querySelectorAll('.star-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const rating = parseInt(this.dataset.rating);
        const songId = this.closest('.rating-stars').dataset.songId;

        fetch(`/api/songs/${songId}/rate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rating: rating })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI
                document.querySelectorAll('.star-btn').forEach(b => {
                    b.classList.toggle('active', parseInt(b.dataset.rating) <= rating);
                });

                // Update user rating text
                document.querySelector('.user-rating-text').textContent = `Your rating: ${rating}/10`;

                // Update average if available
                if (data.rating_count >= 4 && data.avg_rating) {
                    location.reload(); // Reload to show updated average
                }
            } else {
                alert('Error submitting rating: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error submitting rating');
        });
    });
});

// Character counter for comment textarea
const commentTextarea = document.getElementById('comment_text');
const charCount = document.getElementById('char-count');

if (commentTextarea) {
    commentTextarea.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });
}

// Comment submission
const commentForm = document.getElementById('comment-form');
const submitCommentBtn = document.getElementById('submit-comment-btn');
const commentSuccess = document.getElementById('comment-success');
const commentError = document.getElementById('comment-error');
const commentErrorText = document.getElementById('comment-error-text');

if (commentForm) {
    commentForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const commenterName = document.getElementById('commenter_name').value.trim();
        const commentText = document.getElementById('comment_text').value.trim();

        if (!commentText) {
            commentErrorText.textContent = 'Please enter a comment';
            commentError.style.display = 'block';
            return;
        }

        submitCommentBtn.disabled = true;
        submitCommentBtn.textContent = 'Posting...';
        commentSuccess.style.display = 'none';
        commentError.style.display = 'none';

        fetch('/api/songs/{{ song.id }}/comments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                commenter_name: commenterName || null,
                comment_text: commentText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                commentSuccess.style.display = 'block';

                // Clear form
                commentForm.reset();
                charCount.textContent = '0';

                // Reload page after 1 second to show new comment
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                commentErrorText.textContent = data.error || 'Error posting comment';
                commentError.style.display = 'block';
                submitCommentBtn.disabled = false;
                submitCommentBtn.textContent = 'Post Comment';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            commentErrorText.textContent = 'Error posting comment';
            commentError.style.display = 'block';
            submitCommentBtn.disabled = false;
            submitCommentBtn.textContent = 'Post Comment';
        });
    });
}

// Delete comment (admin only)
document.querySelectorAll('.btn-delete-comment').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to delete this comment?')) {
            return;
        }

        const commentId = this.dataset.commentId;

        fetch(`/api/comments/${commentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove comment from DOM
                document.querySelector(`.comment[data-comment-id="${commentId}"]`).remove();

                // Update comment count
                location.reload();
            } else {
                alert('Error deleting comment: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting comment');
        });
    });
});
</script>
{% endblock %}
