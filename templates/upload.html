{% extends "base.html" %}

{% block title %}Upload Song - HastingTX Music{% endblock %}

{% block content %}
<div class="upload-page">
    <h1>Upload New Song</h1>

    <div id="upload-form-container">
        <form id="upload-form" enctype="multipart/form-data">
            <div class="form-section">
                <h3>File Upload</h3>

                <div class="file-drop-zone" id="drop-zone">
                    <p>Drag and drop MP3 file here or click to select</p>
                    <input type="file" id="file-input" name="file" accept=".mp3" required>
                </div>

                <div id="file-info" class="file-info" style="display: none;">
                    <p><strong>Selected file:</strong> <span id="filename"></span></p>
                    <p><strong>Size:</strong> <span id="filesize"></span></p>
                </div>

                <div id="upload-progress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p id="progress-text">Uploading...</p>
                </div>
            </div>

            <div class="form-section">
                <h3>Song Information</h3>

                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="artist">Artist</label>
                    <input type="text" id="artist" name="artist" value="Richard & Claude">
                </div>

                <div class="form-group">
                    <label for="album">Album</label>
                    <input type="text" id="album" name="album">
                </div>

                <div class="form-group">
                    <label for="genre">Genre</label>
                    <input type="text" id="genre" name="genre">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="lyrics">Lyrics</label>
                    <textarea id="lyrics" name="lyrics" rows="10"></textarea>
                </div>

                <div class="form-group">
                    <label for="tags">Tags (comma-separated)</label>
                    <input type="text" id="tags" name="tags" placeholder="rock, upbeat, summer">
                </div>

                <div class="form-group">
                    <label for="identifier">URL Identifier (auto-generated if blank)</label>
                    <input type="text" id="identifier" name="identifier" placeholder="my-song-title">
                    <small>Will be used in the URL: /music/<strong>identifier</strong></small>
                </div>
            </div>

            <div class="form-section">
                <h3>Playlists (optional)</h3>
                <div class="playlist-checkboxes">
                    {% for playlist in playlists %}
                    {% if playlist.identifier != 'all' %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="playlists[]" value="{{ playlist.id }}">
                        {{ playlist.name }}
                    </label>
                    {% endif %}
                    {% endfor %}
                </div>
                <small>Song will automatically be added to "All Songs"</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn">Upload Song</button>
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>

        <div id="upload-success" class="success-message" style="display: none;">
            <h2>Upload Successful!</h2>
            <p id="success-message"></p>
            <div class="success-actions">
                <a id="view-song-link" href="#" class="btn btn-primary">View Song</a>
                <a href="{{ url_for('upload') }}" class="btn btn-secondary">Upload Another</a>
            </div>
        </div>

        <div id="upload-error" class="error-message" style="display: none;">
            <h2>Upload Failed</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="btn btn-secondary">Try Again</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');
const uploadForm = document.getElementById('upload-form');
const uploadProgress = document.getElementById('upload-progress');
const submitBtn = document.getElementById('submit-btn');

// Drag and drop handlers
dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        updateFileInfo(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        updateFileInfo(e.target.files[0]);
    }
});

function updateFileInfo(file) {
    document.getElementById('filename').textContent = file.name;
    document.getElementById('filesize').textContent = formatFileSize(file.size);
    fileInfo.style.display = 'block';

    // Auto-populate title if empty
    if (!document.getElementById('title').value) {
        const title = file.name.replace('.mp3', '').replace(/[-_]/g, ' ');
        document.getElementById('title').value = title;
    }
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Form submission
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(uploadForm);

    // Show progress
    uploadProgress.style.display = 'block';
    submitBtn.disabled = true;

    try {
        const response = await fetch('/admin/upload', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Show success message
            document.getElementById('upload-form-container').querySelector('form').style.display = 'none';
            document.getElementById('success-message').textContent = `"${data.song.title}" has been uploaded successfully!`;
            document.getElementById('view-song-link').href = data.url;
            document.getElementById('upload-success').style.display = 'block';
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('upload-error').style.display = 'block';
        uploadProgress.style.display = 'none';
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}
