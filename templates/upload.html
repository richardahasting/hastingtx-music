{% extends "base.html" %}

{% block title %}Upload Song - HastingTX Music{% endblock %}

{% block content %}
<div class="upload-page">
    <h1>Upload New Song</h1>

    <div id="upload-form-container">
        <form id="upload-form" enctype="multipart/form-data">
            <div class="form-section">
                <h3>File Upload</h3>

                <div class="file-drop-zone" id="drop-zone">
                    <p>Drag and drop MP3 file here or click to select</p>
                    <input type="file" id="file-input" name="file" accept=".mp3" required>
                </div>

                <div id="file-info" class="file-info" style="display: none;">
                    <p><strong>Selected file:</strong> <span id="filename"></span></p>
                    <p><strong>Size:</strong> <span id="filesize"></span></p>
                </div>

                <div id="upload-progress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p id="progress-text">Uploading...</p>
                </div>
            </div>

            <div class="form-section">
                <h3>Song Information</h3>

                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" required>
                </div>

                <div class="form-group">
                    <label for="artist">Artist</label>
                    <input type="text" id="artist" name="artist" value="Richard & Claude">
                </div>

                <div class="form-group">
                    <label for="album-select">Album</label>
                    <select id="album-select" onchange="handleAlbumSelect()">
                        <option value="">-- Select Album --</option>
                        {% for album_name in albums %}
                        <option value="{{ album_name }}">{{ album_name }}</option>
                        {% endfor %}
                        <option value="__new__">+ Create New Album</option>
                    </select>
                    <input type="text" id="album-new" placeholder="Enter new album name" style="display: none; margin-top: 0.5rem;">
                    <input type="hidden" id="album-hidden" name="album">
                    <div id="album-warning" class="album-warning" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label for="genre-select">Genre</label>
                    <select id="genre-select" onchange="handleGenreSelect()">
                        <option value="">-- Select Genre --</option>
                        {% for genre in genres %}
                        {% if not genre.parent_genre_id %}
                        <option value="{{ genre.name }}">{{ genre.name }}</option>
                        {% endif %}
                        {% endfor %}
                        <option value="__new__">+ Create New Genre</option>
                    </select>
                    <input type="hidden" id="genre-hidden" name="genre">

                    <!-- Sub-genre selector (shown when parent genre selected) -->
                    <div id="subgenre-container" style="display: none; margin-top: 0.5rem;">
                        <label for="subgenre-select">Sub-genre (optional)</label>
                        <select id="subgenre-select" onchange="handleSubgenreSelect()">
                            <option value="">-- No sub-genre --</option>
                        </select>
                    </div>

                    <!-- New genre form -->
                    <div id="new-genre-form" style="display: none; margin-top: 0.5rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                        <div class="form-group">
                            <label for="new-genre-name">New Genre Name *</label>
                            <input type="text" id="new-genre-name" placeholder="Enter genre name">
                        </div>
                        <div class="form-group">
                            <label for="new-genre-parent">Parent Genre (for sub-genre)</label>
                            <select id="new-genre-parent">
                                <option value="">-- None (top-level genre) --</option>
                                {% for genre in genres %}
                                {% if not genre.parent_genre_id %}
                                <option value="{{ genre.id }}">{{ genre.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new-genre-desc">Description (optional)</label>
                            <input type="text" id="new-genre-desc" placeholder="Brief description">
                        </div>
                        <button type="button" class="btn btn-small" onclick="createNewGenre()">Create Genre</button>
                        <button type="button" class="btn btn-small btn-secondary" onclick="cancelNewGenre()">Cancel</button>
                        <div id="genre-create-status" style="margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="lyrics">Lyrics</label>
                    <textarea id="lyrics" name="lyrics" rows="10"></textarea>
                </div>

                <div class="form-group">
                    <label for="composer">Composer</label>
                    <input type="text" id="composer" name="composer" value="Richard & Claude">
                </div>

                <div class="form-group">
                    <label for="lyricist">Lyricist</label>
                    <input type="text" id="lyricist" name="lyricist" value="Richard & Claude">
                </div>

                <div class="form-group">
                    <label for="recording_date">Recording Date</label>
                    <input type="date" id="recording_date" name="recording_date">
                </div>

                <div class="form-group">
                    <label for="cover_art">Cover Art (optional)</label>
                    <input type="file" id="cover_art" name="cover_art" accept="image/*">
                    <small>Will be resized to 500x500 if larger. MP3 embedded cover art will be used if not provided.</small>
                </div>

                <div class="form-group">
                    <label for="identifier">URL Identifier (auto-generated if blank)</label>
                    <input type="text" id="identifier" name="identifier" placeholder="my-song-title">
                    <small>Will be used in the URL: /music/<strong>identifier</strong></small>
                </div>
            </div>

            <div class="form-section">
                <h3>Tags (optional)</h3>
                <div class="tag-checkboxes checkbox-grid">
                    {% for tag in tags %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="tags[]" value="{{ tag.id }}">
                        #{{ tag.name }}
                    </label>
                    {% endfor %}
                </div>
                <div class="new-tag-inline" style="margin-top: 0.5rem;">
                    <input type="text" id="new-tag-name" placeholder="Add new tag" style="width: 150px; display: inline-block;">
                    <button type="button" class="btn btn-small" onclick="createNewTag()">Add</button>
                    <span id="tag-create-status" style="margin-left: 0.5rem;"></span>
                </div>
            </div>

            <div class="form-section">
                <h3>Playlists (optional)</h3>
                <div class="playlist-checkboxes">
                    {% for playlist in playlists %}
                    {% if playlist.identifier != 'all' %}
                    <label class="checkbox-label">
                        <input type="checkbox" name="playlists[]" value="{{ playlist.id }}">
                        {{ playlist.name }}
                    </label>
                    {% endif %}
                    {% endfor %}
                </div>
                <small>Song will automatically be added to "All Songs"</small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn">Upload Song</button>
                <a href="{{ url_for('admin') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>

        <div id="upload-success" class="success-message" style="display: none;">
            <h2>Upload Successful!</h2>
            <p id="success-message"></p>
            <div class="success-actions">
                <a id="view-song-link" href="#" class="btn btn-primary">View Song</a>
                <a href="{{ url_for('upload') }}" class="btn btn-secondary">Upload Another</a>
            </div>
        </div>

        <div id="upload-error" class="error-message" style="display: none;">
            <h2>Upload Failed</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="btn btn-secondary">Try Again</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');
const uploadForm = document.getElementById('upload-form');
const uploadProgress = document.getElementById('upload-progress');
const submitBtn = document.getElementById('submit-btn');

// Existing albums for case-insensitive checking
const existingAlbums = [
    {% for album_name in albums %}
    "{{ album_name }}",
    {% endfor %}
];

// Album selection handling
function handleAlbumSelect() {
    const select = document.getElementById('album-select');
    const newInput = document.getElementById('album-new');
    const hiddenInput = document.getElementById('album-hidden');
    const warning = document.getElementById('album-warning');

    if (select.value === '__new__') {
        newInput.style.display = 'block';
        newInput.focus();
        hiddenInput.value = '';
    } else {
        newInput.style.display = 'none';
        newInput.value = '';
        hiddenInput.value = select.value;
        warning.style.display = 'none';
    }
}

// Check for case-insensitive duplicate when typing new album name
document.getElementById('album-new').addEventListener('input', function() {
    const newAlbum = this.value.trim();
    const hiddenInput = document.getElementById('album-hidden');
    const warning = document.getElementById('album-warning');

    if (!newAlbum) {
        hiddenInput.value = '';
        warning.style.display = 'none';
        return;
    }

    // Check for case-insensitive match
    const match = existingAlbums.find(a => a.toLowerCase() === newAlbum.toLowerCase());

    if (match) {
        if (match === newAlbum) {
            // Exact match - use the existing one
            warning.innerHTML = `<span class="warning-info">Album "${match}" already exists. Using existing album.</span>`;
            warning.style.display = 'block';
            hiddenInput.value = match;
        } else {
            // Case difference - warn and use existing
            warning.innerHTML = `<span class="warning-alert">Similar album "${match}" exists. Using existing album to avoid duplicates.</span>`;
            warning.style.display = 'block';
            hiddenInput.value = match;
        }
    } else {
        // New album
        warning.style.display = 'none';
        hiddenInput.value = newAlbum;
    }
});

// Genre data from server
let allGenres = [
    {% for genre in genres %}
    {id: {{ genre.id }}, name: "{{ genre.name }}", parent_genre_id: {{ genre.parent_genre_id or 'null' }}},
    {% endfor %}
];

// Genre selection handling
function handleGenreSelect() {
    const select = document.getElementById('genre-select');
    const hiddenInput = document.getElementById('genre-hidden');
    const newGenreForm = document.getElementById('new-genre-form');
    const subgenreContainer = document.getElementById('subgenre-container');

    if (select.value === '__new__') {
        newGenreForm.style.display = 'block';
        subgenreContainer.style.display = 'none';
        hiddenInput.value = '';
    } else if (select.value) {
        newGenreForm.style.display = 'none';
        hiddenInput.value = select.value;

        // Check if this genre has sub-genres
        const subgenres = allGenres.filter(g => {
            const parent = allGenres.find(p => p.name === select.value);
            return parent && g.parent_genre_id === parent.id;
        });

        if (subgenres.length > 0) {
            populateSubgenres(subgenres);
            subgenreContainer.style.display = 'block';
        } else {
            subgenreContainer.style.display = 'none';
        }
    } else {
        newGenreForm.style.display = 'none';
        subgenreContainer.style.display = 'none';
        hiddenInput.value = '';
    }
}

function populateSubgenres(subgenres) {
    const select = document.getElementById('subgenre-select');
    select.innerHTML = '<option value="">-- No sub-genre --</option>';
    for (const sg of subgenres) {
        const option = document.createElement('option');
        option.value = sg.name;
        option.textContent = sg.name;
        select.appendChild(option);
    }
}

function handleSubgenreSelect() {
    const genreSelect = document.getElementById('genre-select');
    const subgenreSelect = document.getElementById('subgenre-select');
    const hiddenInput = document.getElementById('genre-hidden');

    if (subgenreSelect.value) {
        // Use subgenre as the genre value
        hiddenInput.value = subgenreSelect.value;
    } else {
        // Use parent genre
        hiddenInput.value = genreSelect.value;
    }
}

async function createNewGenre() {
    const name = document.getElementById('new-genre-name').value.trim();
    const parentId = document.getElementById('new-genre-parent').value || null;
    const description = document.getElementById('new-genre-desc').value.trim();
    const status = document.getElementById('genre-create-status');

    if (!name) {
        status.innerHTML = '<span class="warning-alert">Genre name is required</span>';
        return;
    }

    status.innerHTML = 'Creating...';

    try {
        const response = await fetch('/api/genres', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: description || null,
                parent_genre_id: parentId ? parseInt(parentId) : null
            })
        });

        const data = await response.json();

        if (data.success) {
            // Add to local genres array
            allGenres.push(data.genre);

            // Add to appropriate select
            const genreSelect = document.getElementById('genre-select');
            const parentSelect = document.getElementById('new-genre-parent');

            if (parentId) {
                // It's a sub-genre - update the parent's subgenre list if visible
                status.innerHTML = `<span class="warning-info">Sub-genre "${name}" created!</span>`;
            } else {
                // Top-level genre - add to main select before the "Create New" option
                const newOption = document.createElement('option');
                newOption.value = name;
                newOption.textContent = name;
                const createOption = genreSelect.querySelector('option[value="__new__"]');
                genreSelect.insertBefore(newOption, createOption);

                // Also add to parent genre select
                const parentOption = document.createElement('option');
                parentOption.value = data.genre.id;
                parentOption.textContent = name;
                parentSelect.appendChild(parentOption);

                status.innerHTML = `<span class="warning-info">Genre "${name}" created!</span>`;
            }

            // Select the new genre
            document.getElementById('genre-hidden').value = name;

            // Clear form after short delay
            setTimeout(() => {
                document.getElementById('new-genre-name').value = '';
                document.getElementById('new-genre-desc').value = '';
                document.getElementById('new-genre-parent').value = '';
                document.getElementById('new-genre-form').style.display = 'none';
                genreSelect.value = name;
            }, 1500);
        } else {
            status.innerHTML = `<span class="warning-alert">${data.error}</span>`;
        }
    } catch (error) {
        status.innerHTML = `<span class="warning-alert">Error: ${error.message}</span>`;
    }
}

function cancelNewGenre() {
    document.getElementById('new-genre-form').style.display = 'none';
    document.getElementById('genre-select').value = '';
    document.getElementById('genre-hidden').value = '';
    document.getElementById('new-genre-name').value = '';
    document.getElementById('new-genre-desc').value = '';
    document.getElementById('new-genre-parent').value = '';
    document.getElementById('genre-create-status').innerHTML = '';
}

// Drag and drop handlers
dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        updateFileInfo(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        updateFileInfo(e.target.files[0]);
    }
});

function updateFileInfo(file) {
    document.getElementById('filename').textContent = file.name;
    document.getElementById('filesize').textContent = formatFileSize(file.size);
    fileInfo.style.display = 'block';

    // Auto-populate title if empty
    if (!document.getElementById('title').value) {
        const title = file.name.replace('.mp3', '').replace(/[-_]/g, ' ');
        document.getElementById('title').value = title;
    }
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Form submission
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(uploadForm);

    // Show progress
    uploadProgress.style.display = 'block';
    submitBtn.disabled = true;

    try {
        const response = await fetch('/admin/upload', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Show success message
            document.getElementById('upload-form-container').querySelector('form').style.display = 'none';
            document.getElementById('success-message').textContent = `"${data.song.title}" has been uploaded successfully!`;
            document.getElementById('view-song-link').href = data.url;
            document.getElementById('upload-success').style.display = 'block';
        } else {
            throw new Error(data.error || 'Upload failed');
        }
    } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('error-message').textContent = error.message;
        document.getElementById('upload-error').style.display = 'block';
        uploadProgress.style.display = 'none';
        submitBtn.disabled = false;
    }
});

// Create new tag
async function createNewTag() {
    const nameInput = document.getElementById('new-tag-name');
    const status = document.getElementById('tag-create-status');
    const name = nameInput.value.trim().toLowerCase();

    if (!name) {
        status.innerHTML = '<span class="warning-alert">Tag name required</span>';
        return;
    }

    status.innerHTML = 'Creating...';

    try {
        const response = await fetch('/api/tags', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        });

        const data = await response.json();

        if (data.success) {
            // Add checkbox for new tag
            const container = document.querySelector('.tag-checkboxes');
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.innerHTML = `<input type="checkbox" name="tags[]" value="${data.tag.id}" checked> #${data.tag.name}`;
            container.appendChild(label);

            nameInput.value = '';
            status.innerHTML = `<span class="warning-info">Tag "#${data.tag.name}" created!</span>`;
            setTimeout(() => { status.innerHTML = ''; }, 2000);
        } else {
            status.innerHTML = `<span class="warning-alert">${data.error}</span>`;
        }
    } catch (error) {
        status.innerHTML = `<span class="warning-alert">Error: ${error.message}</span>`;
    }
}
</script>
{% endblock %}
