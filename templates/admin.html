{% extends "base.html" %}

{% block title %}Admin Dashboard - HastingTX Music{% endblock %}

{% block nav_extra %}
<li><a href="{{ url_for('upload') }}">Upload Song</a></li>
{% endblock %}

{% block content %}
<div class="admin-page">
    <h1>Admin Dashboard</h1>

    <div class="admin-stats">
        <div class="stat-card">
            <h3>{{ songs|length }}</h3>
            <p>Total Songs</p>
        </div>
        <div class="stat-card">
            <h3>{{ playlists|length }}</h3>
            <p>Playlists</p>
        </div>
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h2>Songs</h2>
            <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload New Song</a>
        </div>

        {% if songs %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Artist</th>
                    <th>Listens</th>
                    <th>Downloads</th>
                    <th>Uploaded</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for song in songs %}
                <tr>
                    <td>
                        <a href="{{ url_for('song', identifier=song.identifier) }}">
                            {{ song.title }}
                        </a>
                    </td>
                    <td>{{ song.artist or '-' }}</td>
                    <td>{{ song.listen_count or 0 }}</td>
                    <td>{{ song.download_count or 0 }}</td>
                    <td>{{ song.upload_date.strftime('%Y-%m-%d') if song.upload_date else '-' }}</td>
                    <td>
                        <a href="{{ url_for('song', identifier=song.identifier) }}" class="btn-small">View</a>
                        <a href="{{ url_for('edit_song', song_id=song.id) }}" class="btn-small">Edit</a>
                        <button class="btn-small btn-danger" onclick="deleteSong({{ song.id }}, '{{ song.title }}')">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No songs uploaded yet.</p>
        {% endif %}
    </div>

    <div class="admin-section">
        <div class="section-header">
            <h2>Playlists</h2>
            <button class="btn btn-primary" onclick="showCreatePlaylistForm()">Create Playlist</button>
        </div>

        <div id="create-playlist-form" class="playlist-form" style="display: none;">
            <h3>Create New Playlist</h3>
            <form onsubmit="createPlaylist(event)">
                <div class="form-group">
                    <label for="playlist-name">Name *</label>
                    <input type="text" id="playlist-name" required>
                </div>
                <div class="form-group">
                    <label for="playlist-description">Description</label>
                    <textarea id="playlist-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="playlist-sort">Default Sort Order</label>
                    <select id="playlist-sort">
                        <option value="manual">Manual</option>
                        <option value="title">Title</option>
                        <option value="album">Album</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create</button>
                    <button type="button" class="btn btn-secondary" onclick="hideCreatePlaylistForm()">Cancel</button>
                </div>
            </form>
        </div>

        {% if playlists %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Songs</th>
                    <th>Sort Order</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for playlist in playlists %}
                <tr>
                    <td>
                        <a href="{{ url_for('playlist', identifier=playlist.identifier) }}">
                            {{ playlist.name }}
                        </a>
                    </td>
                    <td><span id="playlist-count-{{ playlist.id }}">-</span></td>
                    <td>{{ playlist.sort_order }}</td>
                    <td>
                        <a href="{{ url_for('playlist', identifier=playlist.identifier) }}" class="btn-small">View</a>
                        <button class="btn-small" onclick="toggleManageSongs({{ playlist.id }}, '{{ playlist.name }}')">Manage Songs</button>
                        {% if playlist.identifier != 'all' %}
                        <button class="btn-small btn-danger" onclick="deletePlaylist({{ playlist.id }}, '{{ playlist.name }}')">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                <tr id="manage-songs-{{ playlist.id }}" class="manage-songs-row" style="display: none;">
                    <td colspan="4">
                        <div class="manage-songs-container">
                            <h4>Manage Songs in "{{ playlist.name }}"</h4>
                            <div class="songs-checkbox-list" id="songs-list-{{ playlist.id }}">
                                Loading...
                            </div>
                            <div class="manage-songs-actions">
                                <button class="btn btn-primary" onclick="savePlaylistSongs({{ playlist.id }})">Save Changes</button>
                                <button class="btn btn-secondary" onclick="toggleManageSongs({{ playlist.id }})">Cancel</button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showCreatePlaylistForm() {
    document.getElementById('create-playlist-form').style.display = 'block';
}

function hideCreatePlaylistForm() {
    document.getElementById('create-playlist-form').style.display = 'none';
}

async function createPlaylist(event) {
    event.preventDefault();

    const name = document.getElementById('playlist-name').value;
    const description = document.getElementById('playlist-description').value;
    const sortOrder = document.getElementById('playlist-sort').value;

    try {
        const response = await fetch('/admin/playlists/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                description: description,
                sort_order: sortOrder
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('Playlist created successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error creating playlist: ' + error.message);
    }
}

async function deleteSong(songId, title) {
    if (!confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/songs/${songId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            alert('Song deleted successfully');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting song: ' + error.message);
    }
}

async function deletePlaylist(playlistId, name) {
    if (!confirm(`Are you sure you want to delete playlist "${name}"?`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/playlists/${playlistId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            alert('Playlist deleted successfully');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting playlist: ' + error.message);
    }
}

// All songs data (cached)
let allSongs = null;

async function getAllSongs() {
    if (allSongs) return allSongs;
    const response = await fetch('/api/songs');
    allSongs = await response.json();
    return allSongs;
}

async function toggleManageSongs(playlistId, playlistName) {
    const row = document.getElementById(`manage-songs-${playlistId}`);
    const isVisible = row.style.display !== 'none';

    if (isVisible) {
        row.style.display = 'none';
        return;
    }

    // Show the row
    row.style.display = 'table-row';

    // Load songs if not already loaded
    const container = document.getElementById(`songs-list-${playlistId}`);
    if (container.innerHTML === 'Loading...') {
        try {
            const [songs, playlistData] = await Promise.all([
                getAllSongs(),
                fetch(`/api/playlists/${playlistId}/song_ids`).then(r => r.json())
            ]);

            const playlistSongIds = new Set(playlistData.song_ids);

            let html = '<div class="checkbox-grid">';
            for (const song of songs) {
                const checked = playlistSongIds.has(song.id) ? 'checked' : '';
                html += `
                    <label class="checkbox-label">
                        <input type="checkbox" name="song-${playlistId}[]" value="${song.id}" ${checked}>
                        ${song.title} <small>(${song.artist || 'Unknown'})</small>
                    </label>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        } catch (error) {
            container.innerHTML = `<p class="error">Error loading songs: ${error.message}</p>`;
        }
    }
}

async function savePlaylistSongs(playlistId) {
    const checkboxes = document.querySelectorAll(`input[name="song-${playlistId}[]"]:checked`);
    const songIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    try {
        const response = await fetch(`/admin/playlists/${playlistId}/set_songs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ song_ids: songIds })
        });

        const data = await response.json();

        if (data.success) {
            alert(`Playlist updated! Now contains ${data.count} songs.`);
            // Update count display
            document.getElementById(`playlist-count-${playlistId}`).textContent = data.count;
            // Hide the manage row
            document.getElementById(`manage-songs-${playlistId}`).style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error saving playlist: ' + error.message);
    }
}
</script>
{% endblock %}
